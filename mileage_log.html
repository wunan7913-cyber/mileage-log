<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Commission Earner Mileage Log (CRA Compliant)</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font family -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fc;
        }
        /* Custom scrollbar for log area */
        #log-area::-webkit-scrollbar {
            width: 8px;
        }
        #log-area::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 4px;
        }
    </style>
</head>
<body>

<div id="app" class="max-w-4xl mx-auto p-4 sm:p-6 lg:p-8">
    <header class="text-center mb-8">
        <h1 class="text-3xl font-extrabold text-gray-900 mb-2">Business Mileage Log (CRA)</h1>
        <p class="text-gray-600">
            For commission earners: Record your business travel (in **kilometers**) for tax deductions.
        </p>
        <p class="text-sm mt-2 text-blue-600 font-medium" id="user-info">Authenticating...</p>
    </header>

    <!-- Vehicle Selection Card -->
    <div class="bg-white p-6 shadow-xl rounded-xl mb-8 border-t-4 border-purple-500">
        <h2 class="text-xl font-semibold text-gray-800 mb-4">Select Vehicle</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <label for="vehicleSelect" class="block text-sm font-medium text-gray-700">Active Vehicle for Logging/Summary</label>
                <select id="vehicleSelect" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-purple-500 focus:ring-purple-500 p-2 border">
                    <!-- Default vehicle options -->
                    <option value="Sienna">Sienna</option>
                    <option value="Murano">Murano</option>
                </select>
            </div>
            <div class="flex items-end">
                <p class="text-xs text-gray-500 italic">
                    All data and summaries below relate to the selected vehicle.
                </p>
            </div>
        </div>
    </div>

    <!-- Global Odometer Readings Card -->
    <div id="odometer-card" class="bg-white p-6 shadow-xl rounded-xl mb-8 border-t-4 border-blue-500">
        <h2 class="text-xl font-semibold text-gray-800 mb-4">Annual Vehicle Readings (Required by CRA)</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <label for="startOdo" class="block text-sm font-medium text-gray-700">Odometer Reading (Start of Year in km)</label>
                <input type="number" id="startOdo" placeholder="e.g., 15000" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border" min="0">
            </div>
            <div>
                <label for="endOdo" class="block text-sm font-medium text-gray-700">Odometer Reading (End of Year in km)</label>
                <input type="number" id="endOdo" placeholder="e.g., 27500" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border" min="0">
            </div>
        </div>
        <button id="saveOdoBtn" class="mt-4 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-150 ease-in-out shadow-md">
            Save Annual Readings
        </button>
        <p id="odometer-status" class="text-sm mt-3 text-center text-green-600"></p>
    </div>

    <!-- New Trip Input Form -->
    <div class="bg-white p-6 shadow-xl rounded-xl mb-8">
        <h2 class="text-xl font-semibold text-gray-800 mb-4">Log a New Business Trip (Requires Manual Distance Entry)</h2>
        <form id="trip-form" class="space-y-4">
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <!-- Date -->
                <div>
                    <label for="tripDate" class="block text-sm font-medium text-gray-700">Date</label>
                    <input type="date" id="tripDate" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                </div>
                <!-- Mileage -->
                <div>
                    <label for="tripDistance" class="block text-sm font-medium text-gray-700">Distance (Kilometers)</label>
                    <input type="number" id="tripDistance" placeholder="e.g., 75.3 (Use your odometer or a map tool)" step="0.1" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border" min="0.1">
                </div>
            </div>

            <!-- Start Location -->
            <div>
                <label for="tripStart" class="block text-sm font-medium text-gray-700">Start Location / From (Specific Address/Client)</label>
                <input type="text" id="tripStart" placeholder="e.g., Home Office (Start of Day)" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
            </div>

            <!-- End Location -->
            <div>
                <label for="tripEnd" class="block text-sm font-medium text-gray-700">End Location / To (Specific Address/Client)</label>
                <input type="text" id="tripEnd" placeholder="e.g., Client 'Acme Co.' Meeting" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
            </div>

            <!-- Purpose -->
            <div>
                <label for="tripPurpose" class="block text-sm font-medium text-gray-700">Business Purpose (Required by CRA)</label>
                <input type="text" id="tripPurpose" placeholder="e.g., Sales presentation & contract negotiation" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
            </div>

            <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition duration-150 ease-in-out shadow-md">
                Add Trip to Log for <span id="currentVehicleName">Sienna</span>
            </button>
            <p id="trip-status" class="text-sm mt-3 text-center text-red-600"></p>
        </form>
    </div>

    <!-- Log Summary and Trips List -->
    <div class="bg-white p-6 shadow-xl rounded-xl">
        <div class="flex justify-between items-center mb-4 border-b pb-2">
            <h2 class="text-xl font-semibold text-gray-800">Mileage Records for <span id="summaryVehicleName">Sienna</span></h2>
            <button id="exportBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 text-sm font-semibold py-1.5 px-3 rounded-lg transition duration-150 ease-in-out">
                Export CSV
            </button>
        </div>

        <!-- Summary -->
        <div class="grid grid-cols-2 gap-4 text-center mb-4">
            <div class="bg-blue-50 p-3 rounded-lg">
                <p class="text-xs font-medium text-blue-600">Total Business Distance Logged (km)</p>
                <p id="totalBusinessMileage" class="text-2xl font-bold text-blue-800">0.0</p>
            </div>
            <div class="bg-green-50 p-3 rounded-lg">
                <p class="text-xs font-medium text-green-600">Estimated Deduction (CAD, First Tier Rate)</p>
                <p id="totalDeduction" class="text-2xl font-bold text-green-800">$0.00</p>
            </div>
        </div>
        <p class="text-xs text-red-500 italic mb-4 text-center">
            *Deduction uses the first-tier rate (0.70/km) for estimation. Consult the CRA's two-tier system for final tax calculation.
        </p>


        <!-- Trips List -->
        <div id="log-area" class="space-y-4 max-h-96 overflow-y-auto p-2">
            <!-- Trip entries will be injected here -->
            <p class="text-center text-gray-500 italic" id="log-placeholder">Log is empty. Start by adding a trip!</p>
        </div>
    </div>

    <!-- Custom Modal for Delete Confirmation -->
    <div id="deleteModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <h3 class="text-lg font-bold text-gray-900 mb-4">Confirm Deletion</h3>
            <p class="text-gray-600 mb-6">Are you sure you want to delete this trip record?</p>
            <div class="flex justify-end space-x-3">
                <button id="cancelDeleteBtn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition duration-150">Cancel</button>
                <button id="confirmDeleteBtn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition duration-150">Delete</button>
            </div>
        </div>
    </div>
</div>

<!-- Firebase SDKs -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { 
        getAuth, 
        signInAnonymously, 
        signInWithCustomToken, 
        onAuthStateChanged 
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { 
        getFirestore, 
        doc, 
        collection, 
        setDoc, 
        addDoc, 
        onSnapshot, 
        deleteDoc,
        query, 
        where, // <-- New import for filtering
        // Removed: orderBy,
        getDoc,
        setLogLevel
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // IMPORTANT: MANUAL CONFIGURATION FOR EXTERNAL HOSTING
    // You MUST replace the placeholder values below with your actual Firebase project config.
    // The initialAuthToken (which provides secure login) is not available outside the Canvas,
    // so we will switch to permanent anonymous sign-in, which means your data will only
    // be protected by the Firestore Security Rules on that specific project.
    // 
    // This is the configuration for the project where your data is currently stored:
    const MANUAL_FIREBASE_CONFIG = {
        apiKey: "YOUR_API_KEY_HERE",           // REPLACE THIS VALUE
        authDomain: "YOUR_AUTH_DOMAIN_HERE", // REPLACE THIS VALUE
        projectId: "YOUR_PROJECT_ID_HERE",   // REPLACE THIS VALUE
        storageBucket: "YOUR_STORAGE_BUCKET_HERE", // REPLACE THIS VALUE
        messagingSenderId: "YOUR_MESSAGING_SENDER_ID_HERE", // REPLACE THIS VALUE
        appId: "YOUR_APP_ID_HERE"              // REPLACE THIS VALUE
    };

    // IMPORTANT: The following variables are used for compatibility within the Canvas environment.
    // When running externally, they will fall back to the manual config.
    const appId = typeof __app_id !== 'undefined' ? __app_id : MANUAL_FIREBASE_CONFIG.projectId;
    let firebaseConfig = null;
    try {
        firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        // If config is empty (running outside Canvas), use the manual config
        if (Object.keys(firebaseConfig).length === 0 && MANUAL_FIREBASE_CONFIG.projectId !== "YOUR_PROJECT_ID_HERE") {
             firebaseConfig = MANUAL_FIREBASE_CONFIG;
        } else if (Object.keys(firebaseConfig).length === 0) {
             firebaseConfig = {}; // Keep it empty if the manual config is also default
        }
    } catch (e) {
        console.error("Firebase config parsing error.", e);
        firebaseConfig = {};
    }
    // Note: The initialAuthToken is effectively ignored outside the Canvas and we will use signInAnonymously.
    const initialAuthToken = null; 

    // --- Global Variables and Constants ---
    let db;
    let auth;
    let userId = null;
    let isAuthReady = false;
    const TRIP_COLLECTION = 'trips';
    const ODOMETER_COLLECTION = 'odometer';
    
    // Default to the first vehicle
    let activeVehicleId = 'Sienna'; 
    
    // CRA Standard Mileage/Automobile Allowance Rate for 2024 (70 cents/km for first 5,000 km)
    const CRA_STANDARD_RATE_FIRST_TIER = 0.70; 
    let currentTrips = []; // Cache of the current trip data for the active vehicle

    // --- Utility Functions ---

    /**
     * Converts a number to a fixed two decimal string.
     * @param {number} num 
     * @returns {string}
     */
    function toFixed2(num) {
        return (Math.round(num * 100) / 100).toFixed(2);
    }

    /**
     * Converts a millisecond timestamp to a YYYY-MM-DD date string.
     * @param {number} timestamp 
     * @returns {string}
     */
    function formatTimestampToDate(timestamp) {
        const date = new Date(timestamp);
        return date.toISOString().split('T')[0];
    }

    /**
     * Retries a function with exponential backoff.
     * @param {function} fn - The function to retry.
     * @param {number} maxRetries - Maximum number of retries.
     * @param {number} delay - Initial delay in milliseconds.
     */
    async function withRetry(fn, maxRetries = 5, delay = 1000) {
        for (let i = 0; i < maxRetries; i++) {
            try {
                return await fn();
            } catch (error) {
                if (i === maxRetries - 1) {
                    throw error;
                }
                await new Promise(resolve => setTimeout(resolve, delay));
                delay *= 2;
            }
            // Do not log the retry attempt
        }
    }

    // --- Firebase Initialization and Auth ---

    /**
     * Initializes Firebase and authenticates the user.
     */
    async function initializeFirebase() {
        if (!firebaseConfig || Object.keys(firebaseConfig).length === 0) {
            console.error("Firebase is not configured.");
            document.getElementById('user-info').textContent = 'Error: Firebase config missing.';
            return;
        }

        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            // Set logging level for debugging (optional, but useful)
            setLogLevel('debug'); 

            // Since we are likely running outside Canvas, use anonymous sign-in
            if (initialAuthToken) {
                await signInWithCustomToken(auth, initialAuthToken);
            } else {
                await signInAnonymously(auth);
            }

            // Listen for auth state changes
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    isAuthReady = true;
                    document.getElementById('user-info').textContent = `User ID: ${userId} (Anonymous/External)`;
                    
                    // Once authenticated, start listening for data
                    setupDataListeners();
                } else {
                    isAuthReady = false;
                    userId = null;
                    document.getElementById('user-info').textContent = 'Signed in anonymously.';
                }
            });

        } catch (error) {
            console.error("Firebase initialization or sign-in failed:", error);
            document.getElementById('user-info').textContent = `Error: Authentication failed. Check your Firebase config and security rules.`;
        }
    }

    // --- Firestore Data Paths ---

    /**
     * Gets the reference to the user's private trips collection.
     * @returns {import('firebase/firestore').CollectionReference}
     */
    function getTripCollectionRef() {
        if (!db || !userId) return null;
        // Path: /artifacts/{appId}/users/{userId}/trips
        return collection(db, 'artifacts', appId, 'users', userId, TRIP_COLLECTION);
    }

    /**
     * Gets the reference to the odometer document for the active vehicle.
     * @returns {import('firebase/firestore').DocumentReference}
     */
    function getOdometerDocRef(vehicleId) {
        if (!db || !userId) return null;
        // Path: /artifacts/{appId}/users/{userId}/odometer/{Vehicle_ID}
        return doc(db, 'artifacts', appId, 'users', userId, ODOMETER_COLLECTION, vehicleId);
    }

    // --- Data Handlers (Read/Write) ---

    /**
     * Saves the annual odometer readings to Firestore for the active vehicle.
     */
    async function saveOdometerReadings() {
        const startOdo = parseFloat(document.getElementById('startOdo').value);
        const endOdo = parseFloat(document.getElementById('endOdo').value);
        const statusEl = document.getElementById('odometer-status');

        if (isNaN(startOdo) || isNaN(endOdo) || startOdo < 0 || endOdo < 0) {
            statusEl.textContent = 'Please enter valid odometer readings.';
            statusEl.className = 'text-sm mt-3 text-center text-red-600';
            return;
        }

        if (endOdo < startOdo) {
             statusEl.textContent = 'End of year reading cannot be less than start of year reading.';
            statusEl.className = 'text-sm mt-3 text-center text-red-600';
            return;
        }

        const docRef = getOdometerDocRef(activeVehicleId);
        if (!docRef) return;

        try {
            await withRetry(() => setDoc(docRef, { 
                startOdo: startOdo, 
                endOdo: endOdo,
                lastUpdated: Date.now()
            }));
            statusEl.textContent = `Annual readings for ${activeVehicleId} saved successfully!`;
            statusEl.className = 'text-sm mt-3 text-center text-green-600';
        } catch (e) {
            console.error("Error saving odometer readings:", e);
            statusEl.textContent = 'Error saving readings. See console.';
            statusEl.className = 'text-sm mt-3 text-center text-red-600';
        }
    }

    /**
     * Adds a new trip record to Firestore.
     */
    async function addTrip(event) {
        event.preventDefault();
        
        const form = event.target;
        const tripDate = document.getElementById('tripDate').value;
        const tripDistance = parseFloat(document.getElementById('tripDistance').value);
        const tripStart = document.getElementById('tripStart').value;
        const tripEnd = document.getElementById('tripEnd').value;
        const tripPurpose = document.getElementById('tripPurpose').value;
        const statusEl = document.getElementById('trip-status');

        if (!tripDate || isNaN(tripDistance) || tripDistance <= 0 || !tripStart || !tripEnd || !tripPurpose) {
            statusEl.textContent = 'Please fill out all required fields with valid data.';
            statusEl.className = 'text-sm mt-3 text-center text-red-600';
            return;
        }

        const collectionRef = getTripCollectionRef();
        if (!collectionRef) return;

        const newTrip = {
            vehicleId: activeVehicleId, // <-- IMPORTANT: Tag the trip with the active vehicle
            date: new Date(tripDate).getTime(), // Store as timestamp for sorting
            distance: toFixed2(tripDistance),
            start: tripStart.trim(),
            end: tripEnd.trim(),
            purpose: tripPurpose.trim(),
            timestamp: Date.now()
        };

        try {
            await withRetry(() => addDoc(collectionRef, newTrip));
            statusEl.textContent = `Trip added successfully for ${activeVehicleId}!`;
            statusEl.className = 'text-sm mt-3 text-center text-green-600';
            form.reset();
            // Clear status after 3 seconds
            setTimeout(() => statusEl.textContent = '', 3000); 
        } catch (e) {
            console.error("Error adding document:", e);
            statusEl.textContent = 'Error adding trip. Check console.';
            statusEl.className = 'text-sm mt-3 text-center text-red-600';
        }
    }

    /**
     * Deletes a trip record from Firestore.
     * @param {string} docId - The ID of the document to delete.
     */
    async function deleteTrip(docId) {
        const docRef = doc(getTripCollectionRef(), docId);
        try {
            await withRetry(() => deleteDoc(docRef));
            // UI update handled by onSnapshot
        } catch (e) {
            console.error("Error deleting document:", e);
        }
    }

    // --- UI Rendering and Listeners ---

    /**
     * Renders a single trip card element.
     * @param {Object} trip - The trip data.
     * @param {string} id - The Firestore document ID.
     * @returns {HTMLElement | Node}
     */
    function renderTripCard(trip, id) {
        try {
            const div = document.createElement('div');
            div.className = 'trip-card flex justify-between items-start bg-gray-50 p-4 rounded-lg shadow-sm border border-gray-200';
            div.setAttribute('data-id', id);
            
            // CRITICAL CHECK: Ensure all fields needed for rendering are present before generating HTML
            if (!trip.date || !trip.distance || !trip.start || !trip.end || !trip.purpose) {
                console.warn("Skipping display for incomplete trip record:", id, trip);
                // Return a valid, but empty, Node to prevent crash in the main loop
                return document.createElement('div'); 
            }

            const details = `
                <div class="flex-grow">
                    <p class="text-sm text-gray-400">${formatTimestampToDate(trip.date)}</p>
                    <p class="text-lg font-semibold text-blue-700">${trip.distance} km</p>
                    <p class="text-gray-700 mt-1">
                        <span class="font-medium">${trip.start}</span> &rarr; <span class="font-medium">${trip.end}</span>
                    </p>
                    <p class="text-xs text-gray-500 mt-1">Purpose: ${trip.purpose}</p>
                </div>
            `;
            
            const deleteButton = document.createElement('button');
            deleteButton.className = 'delete-btn text-red-500 hover:text-red-700 transition duration-150 p-2 rounded-full';
            deleteButton.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                    <path fill-rule="evenodd" d="M16.5 4.475a.75.75 0 0 1 .75.75V19.5a.75.75 0 0 1-.75.75h-9a.75.75 0 0 1-.75-.75V5.225a.75.75 0 0 1 .75-.75h9ZM10.5 9a.75.75 0 0 0-1.5 0v8.25a.75.75 0 0 0 1.5 0V9ZM13.5 9a.75.75 0 0 0-1.5 0v8.25a.75.75 0 0 0 1.5 0V9Z" clip-rule="evenodd" />
                    <path d="M12 2.25a.75.75 0 0 1 .75.75V5.25a.75.75 0 0 1-1.5 0V3a.75.75 0 0 1 .75-.75Z" />
                </svg>
            `;
            deleteButton.onclick = (e) => {
                e.stopPropagation();
                showDeleteModal(id);
            };

            div.innerHTML = details;
            div.appendChild(deleteButton);
            return div;
        } catch (e) {
            console.error("Critical failure during trip card rendering for ID:", id, e);
            // Return a valid empty element (a Node) to prevent the TypeError
            return document.createElement('div');
        }
    }

    /**
     * Updates the UI with the latest list of trips and total summary.
     * @param {Array<Object>} trips - Array of trip objects from Firestore.
     */
    function updateTripLogUI(trips) {
        currentTrips = trips;
        const logArea = document.getElementById('log-area');
        logArea.innerHTML = ''; // Clear existing trips
        
        if (trips.length === 0) {
            // DYNAMICALLY CREATE PLACEHOLDER
            // We create this element fresh every time the list is empty.
            // This prevents the "parameter 1 is not of type 'Node'" error which occurs
            // when we try to append a 'null' element (because the original placeholder
            // was deleted when we did logArea.innerHTML = '').
            const p = document.createElement('p');
            p.className = "text-center text-gray-500 italic";
            p.id = "log-placeholder";
            p.textContent = "Log is empty. Start by adding a trip!";
            logArea.appendChild(p);

            document.getElementById('totalBusinessMileage').textContent = toFixed2(0.0);
            document.getElementById('totalDeduction').textContent = `$${toFixed2(0.0)}`;
            return;
        }

        let totalMileage = 0;
        // FIX: Sort the data using JavaScript in memory since Firestore orderBy was removed to avoid index error
        trips.sort((a, b) => b.date - a.date);

        trips.forEach(trip => {
            const distance = parseFloat(trip.distance || 0);
            totalMileage += distance;
            const tripCard = renderTripCard(trip, trip.id);
            
            // CRITICAL FIX: Explicitly check that tripCard is a Node instance 
            // This handles cases where renderTripCard might return an invalid object reference.
            if (tripCard instanceof Node) { 
                logArea.appendChild(tripCard);
            } else {
                 console.warn("Skipped appending invalid tripCard for ID:", trip.id);
            }
        });

        // Update Summary
        document.getElementById('totalBusinessMileage').textContent = toFixed2(totalMileage);
        const totalDeduction = totalMileage * CRA_STANDARD_RATE_FIRST_TIER;
        document.getElementById('totalDeduction').textContent = `$${toFixed2(totalDeduction)}`;
    }
    
    /**
     * Updates the Odometer fields based on data for the currently active vehicle.
     * @param {Object} odometerData
     */
    function updateOdometerUI(odometerData) {
        const startOdoEl = document.getElementById('startOdo');
        const endOdoEl = document.getElementById('endOdo');
        const statusEl = document.getElementById('odometer-status');

        if (odometerData) {
            startOdoEl.value = odometerData.startOdo || '';
            endOdoEl.value = odometerData.endOdo || '';
            statusEl.textContent = `Readings for ${activeVehicleId} loaded.`;
            statusEl.className = 'text-sm mt-3 text-center text-green-600';
        } else {
            startOdoEl.value = '';
            endOdoEl.value = '';
            statusEl.textContent = `No annual readings found for ${activeVehicleId}. Please enter them.`;
            statusEl.className = 'text-sm mt-3 text-center text-blue-600';
        }
    }
    
    /**
     * Fetches and updates the annual odometer readings for the active vehicle.
     */
    async function fetchOdometerForActiveVehicle() {
        if (!isAuthReady || !userId || !db) return;
        
        const docRef = getOdometerDocRef(activeVehicleId);
        if (docRef) {
            try {
                const docSnap = await withRetry(() => getDoc(docRef));
                if (docSnap.exists()) {
                    updateOdometerUI(docSnap.data());
                } else {
                    updateOdometerUI(null);
                }
            } catch(e) {
                console.error("Error fetching odometer data:", e);
            }
        }
    }
    
    /**
     * Updates the UI elements reflecting the active vehicle name.
     */
    function updateVehicleNameUI() {
        const vehicleName = document.getElementById('vehicleSelect').options[document.getElementById('vehicleSelect').selectedIndex].text;
        document.getElementById('currentVehicleName').textContent = vehicleName;
        document.getElementById('summaryVehicleName').textContent = vehicleName;
    }

    /**
     * Sets up the real-time listeners for all data.
     */
    function setupDataListeners() {
        if (!isAuthReady || !userId || !db) return;

        // 1. Get initial Odometer readings
        fetchOdometerForActiveVehicle();
        
        // 2. Listen for Trip updates, filtered by activeVehicleId
        // FIX: Removed orderBy('date', 'desc') to avoid the composite index error.
        // Sorting is now handled in updateTripLogUI via JavaScript.
        const tripsCollectionRef = getTripCollectionRef();
        const q = query(
            tripsCollectionRef, 
            where('vehicleId', '==', activeVehicleId) // <-- Filter by active vehicle
        );

        onSnapshot(q, (snapshot) => {
            const trips = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            updateTripLogUI(trips);
        }, (error) => {
            // Note: Since we are catching the error here, it won't crash the app, but log it.
            console.error("Error fetching filtered trips:", error); 
        });
    }
    
    /**
     * Handles the change event for the vehicle selector.
     */
    function handleVehicleChange() {
        const newVehicleId = document.getElementById('vehicleSelect').value;
        activeVehicleId = newVehicleId;
        updateVehicleNameUI();
        
        // Re-run data listeners to switch context (Odometer and Trip List)
        setupDataListeners();
    }


    // --- Modal Logic ---
    const deleteModal = document.getElementById('deleteModal');
    const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
    const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
    let tripToDeleteId = null;

    function showDeleteModal(id) {
        tripToDeleteId = id;
        deleteModal.classList.remove('hidden');
    }

    function hideDeleteModal() {
        tripToDeleteId = null;
        deleteModal.classList.add('hidden');
    }

    confirmDeleteBtn.onclick = () => {
        if (tripToDeleteId) {
            deleteTrip(tripToDeleteId);
        }
        hideDeleteModal();
    };

    cancelDeleteBtn.onclick = hideDeleteModal;

    // Close modal if user clicks outside of it
    deleteModal.onclick = (e) => {
        if (e.target === deleteModal) {
            hideDeleteModal();
        }
    };

    // --- CSV Export Logic ---

    /**
     * Exports the current trips data to a CSV file.
     */
    function exportToCSV() {
        if (currentTrips.length === 0) {
            const statusEl = document.getElementById('trip-status');
            statusEl.textContent = 'No trips to export for this vehicle.';
            statusEl.className = 'text-sm mt-3 text-center text-red-600';
            setTimeout(() => statusEl.textContent = '', 3000);
            return;
        }

        const vehicleName = document.getElementById('vehicleSelect').options[document.getElementById('vehicleSelect').selectedIndex].text;

        // CSV Header (Updated to Kilometers)
        let csv = `Vehicle,Date,Distance (Kilometers),Start Location,End Location,Business Purpose,Total Annual Business Kilometers (YTD)\n`;
        
        // Calculate YTD total mileage
        let totalMileage = 0;
        currentTrips.forEach(trip => {
            totalMileage += parseFloat(trip.distance);
        });
        
        // CSV Body
        currentTrips.forEach(trip => {
            const date = formatTimestampToDate(trip.date);
            const row = [
                vehicleName, // Added Vehicle Name
                date,
                trip.distance,
                `"${trip.start.replace(/"/g, '""')}"`, // Handle quotes in text fields
                `"${trip.end.replace(/"/g, '""')}"`,
                `"${trip.purpose.replace(/"/g, '""')}"`,
                toFixed2(totalMileage)
            ].join(',');
            csv += row + "\n";
        });

        // Create Blob and download link
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', `CRA_Mileage_Log_Export_${activeVehicleId}_${new Date().toISOString().split('T')[0]}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // --- Event Listeners and Setup ---
    document.addEventListener('DOMContentLoaded', () => {
        // Set today's date as default for convenience
        document.getElementById('tripDate').value = formatTimestampToDate(Date.now());
        
        // Set up initial vehicle name display
        updateVehicleNameUI();

        // Set up form submission and button clicks
        document.getElementById('trip-form').addEventListener('submit', addTrip);
        document.getElementById('saveOdoBtn').addEventListener('click', saveOdometerReadings);
        document.getElementById('exportBtn').addEventListener('click', exportToCSV);
        
        // Vehicle selector change listener is now added here (once)
        document.getElementById('vehicleSelect').addEventListener('change', handleVehicleChange);

        // Start the whole process
        initializeFirebase();
    });

</script>
</body>
</html>
