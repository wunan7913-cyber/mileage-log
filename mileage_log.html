<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Commission Earner Mileage Log (CRA Compliant)</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font family -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fc;
        }
        /* Custom scrollbar for log area */
        #log-area::-webkit-scrollbar {
            width: 8px;
        }
        #log-area::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 4px;
        }
    </style>
</head>
<body>

<div id="app" class="max-w-4xl mx-auto p-4 sm:p-6 lg:p-8">
    
    <!-- Login Screen (Visible when signed out) -->
    <div id="login-screen" class="hidden flex flex-col items-center justify-center min-h-[60vh] text-center">
        <div class="bg-white p-8 rounded-xl shadow-2xl max-w-md w-full border-t-4 border-blue-600">
            <h1 class="text-3xl font-extrabold text-gray-900 mb-4">Mileage Log</h1>
            <p class="text-gray-600 mb-8">Sign in to access your synchronized vehicle logs across all your devices.</p>
            <button id="googleSignInBtn" class="flex items-center justify-center w-full bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 font-bold py-3 px-4 rounded-lg transition duration-150 ease-in-out shadow-sm group">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-6 h-6 mr-3" alt="Google logo">
                <span class="group-hover:text-blue-600">Sign in with Google</span>
            </button>
            <!-- Error message container -->
            <div id="auth-status-msg" class="mt-4 text-sm text-red-500 w-full text-left"></div>
        </div>
    </div>

    <!-- Main App Content (Visible when signed in) -->
    <div id="app-content" class="hidden">
        <header class="text-center mb-8 relative">
            <h1 class="text-3xl font-extrabold text-gray-900 mb-2">Business Mileage Log (CRA)</h1>
            <p class="text-gray-600">
                For commission earners: Record your business travel (in **kilometers**) for tax deductions.
            </p>
            <div class="mt-4 flex flex-col sm:flex-row items-center justify-center gap-2">
                <p class="text-sm text-blue-600 font-medium" id="user-info">Authenticating...</p>
                <button id="signOutBtn" class="text-xs bg-gray-200 hover:bg-gray-300 px-3 py-1 rounded text-gray-700">Sign Out</button>
            </div>
        </header>

        <!-- Vehicle Selection Card -->
        <div class="bg-white p-6 shadow-xl rounded-xl mb-8 border-t-4 border-purple-500">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Select Vehicle</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="vehicleSelect" class="block text-sm font-medium text-gray-700">Active Vehicle for Logging/Summary</label>
                    <select id="vehicleSelect" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-purple-500 focus:ring-purple-500 p-2 border">
                        <!-- Default vehicle options -->
                        <option value="Sienna">Sienna</option>
                        <option value="Murano">Murano</option>
                    </select>
                </div>
                <div class="flex items-end">
                    <p class="text-xs text-gray-500 italic">
                        All data and summaries below relate to the selected vehicle.
                    </p>
                </div>
            </div>
        </div>

        <!-- Global Odometer Readings Card -->
        <div id="odometer-card" class="bg-white p-6 shadow-xl rounded-xl mb-8 border-t-4 border-blue-500">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Annual Vehicle Readings (Required by CRA)</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="startOdo" class="block text-sm font-medium text-gray-700">Odometer Reading (Start of Year in km)</label>
                    <input type="number" id="startOdo" placeholder="e.g., 15000" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border" min="0">
                </div>
                <div>
                    <label for="endOdo" class="block text-sm font-medium text-gray-700">Odometer Reading (End of Year in km)</label>
                    <input type="number" id="endOdo" placeholder="e.g., 27500" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border" min="0">
                </div>
            </div>
            <button id="saveOdoBtn" class="mt-4 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-150 ease-in-out shadow-md">
                Save Annual Readings
            </button>
            <p id="odometer-status" class="text-sm mt-3 text-center text-green-600"></p>
        </div>

        <!-- New Trip Input Form -->
        <div class="bg-white p-6 shadow-xl rounded-xl mb-8">
            <!-- RE-ADDED currentVehicleName SPAN HERE -->
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Log Trip for <span id="currentVehicleName" class="text-blue-600">Sienna</span></h2>
            <form id="trip-form" class="space-y-4">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <!-- Date -->
                    <div>
                        <label for="tripDate" class="block text-sm font-medium text-gray-700">Date</label>
                        <input type="date" id="tripDate" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                    </div>
                    <!-- Mileage -->
                    <div>
                        <label for="tripDistance" class="block text-sm font-medium text-gray-700">Distance (Kilometers)</label>
                        <input type="number" id="tripDistance" placeholder="e.g., 75.3 (Use your odometer or a map tool)" step="0.1" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border" min="0.1">
                    </div>
                </div>

                <!-- Start Location -->
                <div>
                    <label for="tripStart" class="block text-sm font-medium text-gray-700">Start Location / From (Specific Address/Client)</label>
                    <input type="text" id="tripStart" value="33 Panatella Way NW, Calgary T3K 6C4" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                </div>

                <!-- End Location -->
                <div>
                    <label for="tripEnd" class="block text-sm font-medium text-gray-700">End Location / To (Specific Address/Client)</label>
                    <input type="text" id="tripEnd" placeholder="e.g., Client 'Acme Co.' Meeting" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                </div>

                <!-- Purpose -->
                <div>
                    <label for="tripPurpose" class="block text-sm font-medium text-gray-700">Business Purpose (Required by CRA)</label>
                    <input type="text" id="tripPurpose" placeholder="e.g., Sales presentation & contract negotiation" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                </div>

                <div class="flex flex-col sm:flex-row gap-3 pt-2">
                    <button type="submit" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition duration-150 ease-in-out shadow-md">
                        Log One Way
                    </button>
                    <button type="button" id="roundTripBtn" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition duration-150 ease-in-out shadow-md flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M7.5 21 3 16.5m0 0L7.5 12M3 16.5h13.5m0-13.5L21 7.5m0 0L16.5 12M21 7.5H7.5" />
                        </svg>
                        Log Round Trip (x2)
                    </button>
                </div>
                <p id="trip-status" class="text-sm mt-3 text-center text-gray-600 font-medium h-5"></p>
            </form>
        </div>

        <!-- Log Summary and Trips List -->
        <div class="bg-white p-6 shadow-xl rounded-xl">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h2 class="text-xl font-semibold text-gray-800">Mileage Records for <span id="summaryVehicleName">Sienna</span></h2>
                <button id="exportBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 text-sm font-semibold py-1.5 px-3 rounded-lg transition duration-150 ease-in-out">
                    Export CSV
                </button>
            </div>

            <!-- Summary -->
            <div class="grid grid-cols-2 gap-4 text-center mb-4">
                <div class="bg-blue-50 p-3 rounded-lg">
                    <p class="text-xs font-medium text-blue-600">Total Business Distance Logged (km)</p>
                    <p id="totalBusinessMileage" class="text-2xl font-bold text-blue-800">0.0</p>
                </div>
                <div class="bg-green-50 p-3 rounded-lg">
                    <p class="text-xs font-medium text-green-600">Estimated Deduction (CAD, First Tier Rate)</p>
                    <p id="totalDeduction" class="text-2xl font-bold text-green-800">$0.00</p>
                </div>
            </div>
            <p class="text-xs text-red-500 italic mb-4 text-center">
                *Deduction uses the first-tier rate (0.70/km) for estimation. Consult the CRA's two-tier system for final tax calculation.
            </p>


            <!-- Trips List -->
            <div id="log-area" class="space-y-4 max-h-96 overflow-y-auto p-2">
                <!-- Trip entries will be injected here -->
                <p class="text-center text-gray-500 italic" id="log-placeholder">Log is empty. Start by adding a trip!</p>
            </div>
        </div>

        <!-- Custom Modal for Delete Confirmation -->
        <div id="deleteModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
            <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
                <h3 class="text-lg font-bold text-gray-900 mb-4">Confirm Deletion</h3>
                <p class="text-gray-600 mb-6">Are you sure you want to delete this trip record?</p>
                <div class="flex justify-end space-x-3">
                    <button id="cancelDeleteBtn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition duration-150">Cancel</button>
                    <button id="confirmDeleteBtn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition duration-150">Delete</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Firebase SDKs -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { 
        getAuth, 
        signInAnonymously, 
        signInWithPopup, 
        signInWithCustomToken, 
        GoogleAuthProvider,
        signOut,
        onAuthStateChanged 
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { 
        getFirestore, 
        doc, 
        collection, 
        setDoc, 
        addDoc, 
        onSnapshot, 
        deleteDoc,
        query, 
        where, 
        getDoc,
        setLogLevel
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // IMPORTANT: MANUAL CONFIGURATION FOR EXTERNAL HOSTING
    // You MUST replace the placeholder values below with your actual Firebase project config.
    const MANUAL_FIREBASE_CONFIG = {
        apiKey: "AIzaSyDNliJSv3NVQNTExt6utLyfXLQ0yfoyEEg",
        authDomain: "mileage-log-ada55.firebaseapp.com",
        projectId: "mileage-log-ada55",
        storageBucket: "mileage-log-ada55.firebasestorage.app",
        messagingSenderId: "209737174746",
        appId: "1:209737174746:web:98170143d8cf72fdc8dfe3",
        measurementId: "G-Q772FPDE0B"
    };

    // Fallback logic for environment
    const appId = typeof __app_id !== 'undefined' ? __app_id : MANUAL_FIREBASE_CONFIG.projectId;
    let firebaseConfig = null;
    try {
        firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        if (Object.keys(firebaseConfig).length === 0 && MANUAL_FIREBASE_CONFIG.projectId !== "YOUR_PROJECT_ID_HERE") {
             firebaseConfig = MANUAL_FIREBASE_CONFIG;
        } else if (Object.keys(firebaseConfig).length === 0) {
             firebaseConfig = {}; 
        }
    } catch (e) {
        console.error("Firebase config parsing error.", e);
        firebaseConfig = {};
    }
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null; 

    // --- Global Variables and Constants ---
    let db;
    let auth;
    let userId = null;
    let unsubscribeTrips = null;
    let unsubscribeOdo = null;
    const TRIP_COLLECTION = 'trips';
    const ODOMETER_COLLECTION = 'odometer';
    
    // Default to the first vehicle
    let activeVehicleId = 'Sienna'; 
    
    // CRA Standard Mileage/Automobile Allowance Rate for 2024 (70 cents/km for first 5,000 km)
    const CRA_STANDARD_RATE_FIRST_TIER = 0.70; 
    let currentTrips = []; // Cache of the current trip data for the active vehicle

    // --- Utility Functions ---

    /**
     * Converts a number to a fixed two decimal string.
     * @param {number} num 
     * @returns {string}
     */
    function toFixed2(num) {
        return (Math.round(num * 100) / 100).toFixed(2);
    }

    /**
     * Converts a millisecond timestamp to a YYYY-MM-DD date string.
     * @param {number} timestamp 
     * @returns {string}
     */
    function formatTimestampToDate(timestamp) {
        const date = new Date(timestamp);
        return date.toISOString().split('T')[0];
    }

    /**
     * Retries a function with exponential backoff.
     */
    async function withRetry(fn, maxRetries = 5, delay = 1000) {
        for (let i = 0; i < maxRetries; i++) {
            try {
                return await fn();
            } catch (error) {
                if (i === maxRetries - 1) {
                    throw error;
                }
                await new Promise(resolve => setTimeout(resolve, delay));
                delay *= 2;
            }
        }
    }

    // --- Firebase Initialization and Auth ---

    async function initializeFirebase() {
        if (!firebaseConfig || Object.keys(firebaseConfig).length === 0) {
            console.error("Firebase is not configured.");
            return;
        }

        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            setLogLevel('debug'); 

            // Auth Listener
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    // User is signed in
                    userId = user.uid;
                    document.getElementById('user-info').textContent = `Signed in as: ${user.email || 'Anonymous'}`;
                    
                    // Show App, Hide Login
                    document.getElementById('login-screen').classList.add('hidden');
                    document.getElementById('app-content').classList.remove('hidden');

                    setupDataListeners();
                } else {
                    // User is signed out
                    userId = null;
                    unsubscribeListeners(); // Stop listening to old data
                    
                    // Show Login, Hide App
                    document.getElementById('login-screen').classList.remove('hidden');
                    document.getElementById('app-content').classList.add('hidden');
                }
            });

            // If we are in the immersive environment (dev mode) and have a token, use it
            if (initialAuthToken) {
                await signInWithCustomToken(auth, initialAuthToken);
            }

        } catch (error) {
            console.error("Firebase init failed:", error);
            document.getElementById('auth-status-msg').textContent = "Initialization failed. Check console.";
        }
    }

    // --- Auth Functions ---

    window.loginWithGoogle = async () => {
        try {
            const provider = new GoogleAuthProvider();
            await signInWithPopup(auth, provider);
        } catch (error) {
            console.error("Login failed:", error);
            const errorDiv = document.getElementById('auth-status-msg');
            
            // Helpful error handling
            if (error.code === 'auth/unauthorized-domain') {
                const domain = window.location.hostname;
                errorDiv.innerHTML = `
                    <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative text-left text-sm mt-3">
                        <strong class="font-bold">Configuration Error:</strong>
                        <p class="mb-2">Firebase rejected this domain.</p>
                        <p class="mb-1">1. Go to <a href="https://console.firebase.google.com/" target="_blank" class="underline font-bold">Firebase Console</a></p>
                        <p class="mb-1">2. Navigate to <strong>Authentication</strong> > <strong>Settings</strong> > <strong>Authorized domains</strong></p>
                        <p class="mb-1">3. Click "Add domain" and paste this:</p>
                        <code class="block bg-red-50 p-2 mt-1 rounded border border-red-200 select-all font-mono font-bold">${domain}</code>
                    </div>
                `;
            } else if (error.code === 'auth/operation-not-allowed') {
                 errorDiv.innerHTML = `
                    <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative text-left text-sm mt-3">
                        <strong class="font-bold">Configuration Error:</strong>
                        <p class="mb-2">Google Sign-In is disabled.</p>
                        <p class="mb-1">1. Go to <a href="https://console.firebase.google.com/" target="_blank" class="underline font-bold">Firebase Console</a></p>
                        <p class="mb-1">2. Navigate to <strong>Authentication</strong> > <strong>Sign-in method</strong></p>
                        <p class="mb-1">3. Click <strong>Google</strong>, toggle <strong>Enable</strong>, and Save.</p>
                    </div>
                `;
            } else if (error.code === 'auth/popup-closed-by-user') {
                errorDiv.textContent = "Sign-in cancelled.";
            } else {
                errorDiv.textContent = "Login failed: " + error.message;
            }
        }
    };

    window.logout = async () => {
        try {
            await signOut(auth);
        } catch (error) {
            console.error("Logout failed:", error);
        }
    };

    // --- Firestore Data Paths ---

    function getTripCollectionRef() {
        if (!db || !userId) return null;
        return collection(db, 'artifacts', appId, 'users', userId, TRIP_COLLECTION);
    }

    function getOdometerDocRef(vehicleId) {
        if (!db || !userId) return null;
        return doc(db, 'artifacts', appId, 'users', userId, ODOMETER_COLLECTION, vehicleId);
    }

    // --- Data Handlers ---

    async function saveOdometerReadings() {
        const startOdoVal = document.getElementById('startOdo').value;
        const endOdoVal = document.getElementById('endOdo').value;
        const startOdo = parseFloat(startOdoVal);
        const endOdo = endOdoVal.trim() === '' ? null : parseFloat(endOdoVal);
        const statusEl = document.getElementById('odometer-status');

        if (isNaN(startOdo) || startOdo < 0) {
            statusEl.textContent = 'Please enter a valid Start of Year odometer reading.';
            statusEl.className = 'text-sm mt-3 text-center text-red-600';
            return;
        }

        if (endOdo !== null) {
            if (isNaN(endOdo) || endOdo < 0) {
                statusEl.textContent = 'Please enter a valid End of Year reading (or leave blank).';
                statusEl.className = 'text-sm mt-3 text-center text-red-600';
                return;
            }
            if (endOdo < startOdo) {
                statusEl.textContent = 'End of year reading cannot be less than start of year reading.';
                statusEl.className = 'text-sm mt-3 text-center text-red-600';
                return;
            }
        }

        const docRef = getOdometerDocRef(activeVehicleId);
        if (!docRef) return;

        try {
            await withRetry(() => setDoc(docRef, { 
                startOdo: startOdo, 
                endOdo: endOdo,
                lastUpdated: Date.now()
            }));
            statusEl.textContent = `Annual readings for ${activeVehicleId} saved successfully!`;
            statusEl.className = 'text-sm mt-3 text-center text-green-600';
        } catch (e) {
            console.error("Error saving odometer readings:", e);
            statusEl.textContent = 'Error saving readings. See console.';
            statusEl.className = 'text-sm mt-3 text-center text-red-600';
        }
    }

    /**
     * Helper to write a trip object to Firestore.
     */
    async function writeTripToFirestore(tripData) {
        const collectionRef = getTripCollectionRef();
        if (!collectionRef) return;
        await withRetry(() => addDoc(collectionRef, tripData));
    }

    /**
     * Helper to extract and validate trip data from form.
     * Returns null if invalid, otherwise returns data object.
     */
    function extractTripDataFromForm() {
        const tripDate = document.getElementById('tripDate').value;
        const tripDistanceVal = document.getElementById('tripDistance').value;
        const tripStart = document.getElementById('tripStart').value;
        const tripEnd = document.getElementById('tripEnd').value;
        const tripPurpose = document.getElementById('tripPurpose').value;
        const tripDistance = parseFloat(tripDistanceVal);

        if (!tripDate || isNaN(tripDistance) || tripDistance <= 0 || !tripStart || !tripEnd || !tripPurpose) {
            return null;
        }

        return {
            vehicleId: activeVehicleId, 
            dateStr: tripDate, // Keep raw string for date object creation
            distance: toFixed2(tripDistance),
            start: tripStart.trim(),
            end: tripEnd.trim(),
            purpose: tripPurpose.trim()
        };
    }

    /**
     * Resets form and status.
     */
    function resetForm(statusEl, successMessage) {
        document.getElementById('trip-form').reset();
        // Restore default address after reset
        document.getElementById('tripStart').value = "33 Panatella Way NW, Calgary T3K 6C4";
        // Restore default date
        document.getElementById('tripDate').value = formatTimestampToDate(Date.now());
        
        statusEl.textContent = successMessage;
        statusEl.className = 'text-sm mt-3 text-center text-green-600 font-medium h-5';
        setTimeout(() => statusEl.textContent = '', 3000); 
    }

    async function addTrip(event) {
        event.preventDefault();
        const statusEl = document.getElementById('trip-status');
        const data = extractTripDataFromForm();

        if (!data) {
            statusEl.textContent = 'Please fill out all required fields with valid data.';
            statusEl.className = 'text-sm mt-3 text-center text-red-600 font-medium h-5';
            return;
        }

        const newTrip = {
            vehicleId: data.vehicleId, 
            date: new Date(data.dateStr).getTime(), 
            distance: data.distance,
            start: data.start,
            end: data.end,
            purpose: data.purpose,
            timestamp: Date.now()
        };

        try {
            await writeTripToFirestore(newTrip);
            resetForm(statusEl, `Trip added successfully for ${activeVehicleId}!`);
        } catch (e) {
            console.error("Error adding document:", e);
            statusEl.textContent = 'Error adding trip. Check console.';
            statusEl.className = 'text-sm mt-3 text-center text-red-600 font-medium h-5';
        }
    }

    async function addRoundTrip(event) {
        // Prevent default if it was triggered by a form submit (though it's type=button)
        if (event) event.preventDefault();
        
        const statusEl = document.getElementById('trip-status');
        const data = extractTripDataFromForm();

        if (!data) {
            statusEl.textContent = 'Please fill out all required fields with valid data.';
            statusEl.className = 'text-sm mt-3 text-center text-red-600 font-medium h-5';
            return;
        }

        const timestamp = Date.now();

        // Trip 1: Start -> End
        const trip1 = {
            vehicleId: data.vehicleId, 
            date: new Date(data.dateStr).getTime(), 
            distance: data.distance,
            start: data.start,
            end: data.end,
            purpose: data.purpose,
            timestamp: timestamp // Original time
        };

        // Trip 2: End -> Start (Return)
        const trip2 = {
            vehicleId: data.vehicleId, 
            // We use same date. 
            date: new Date(data.dateStr).getTime(), 
            distance: data.distance,
            start: data.end, // Swap start
            end: data.start, // Swap end
            purpose: data.purpose + " (Return)", // Optional: Add suffix or keep same? Usually keep same is fine, but return implies logic. Let's keep same to match user intent of just logging the return.
            timestamp: timestamp + 60000 // Add 1 minute to return trip so it appears 'after' if sorted by creation
        };

        try {
            // Save both
            await writeTripToFirestore(trip1);
            await writeTripToFirestore(trip2);
            resetForm(statusEl, `Round trip (2 entries) added successfully!`);
        } catch (e) {
            console.error("Error adding round trip:", e);
            statusEl.textContent = 'Error adding trips. Check console.';
            statusEl.className = 'text-sm mt-3 text-center text-red-600 font-medium h-5';
        }
    }

    async function deleteTrip(docId) {
        const docRef = doc(getTripCollectionRef(), docId);
        try {
            await withRetry(() => deleteDoc(docRef));
        } catch (e) {
            console.error("Error deleting document:", e);
        }
    }

    // --- UI Rendering ---

    function renderTripCard(trip, id) {
        try {
            const div = document.createElement('div');
            div.className = 'trip-card flex justify-between items-start bg-gray-50 p-4 rounded-lg shadow-sm border border-gray-200';
            div.setAttribute('data-id', id);
            
            if (!trip.date || !trip.distance || !trip.start || !trip.end || !trip.purpose) {
                console.warn("Skipping display for incomplete trip record:", id, trip);
                return document.createElement('div'); 
            }

            const details = `
                <div class="flex-grow">
                    <p class="text-sm text-gray-400">${formatTimestampToDate(trip.date)}</p>
                    <p class="text-lg font-semibold text-blue-700">${trip.distance} km</p>
                    <p class="text-gray-700 mt-1">
                        <span class="font-medium">${trip.start}</span> &rarr; <span class="font-medium">${trip.end}</span>
                    </p>
                    <p class="text-xs text-gray-500 mt-1">Purpose: ${trip.purpose}</p>
                </div>
            `;
            
            const deleteButton = document.createElement('button');
            deleteButton.className = 'delete-btn text-red-500 hover:text-red-700 transition duration-150 p-2 rounded-full';
            deleteButton.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                    <path fill-rule="evenodd" d="M16.5 4.475a.75.75 0 0 1 .75.75V19.5a.75.75 0 0 1-.75.75h-9a.75.75 0 0 1-.75-.75V5.225a.75.75 0 0 1 .75-.75h9ZM10.5 9a.75.75 0 0 0-1.5 0v8.25a.75.75 0 0 0 1.5 0V9ZM13.5 9a.75.75 0 0 0-1.5 0v8.25a.75.75 0 0 0 1.5 0V9Z" clip-rule="evenodd" />
                    <path d="M12 2.25a.75.75 0 0 1 .75.75V5.25a.75.75 0 0 1-1.5 0V3a.75.75 0 0 1 .75-.75Z" />
                </svg>
            `;
            deleteButton.onclick = (e) => {
                e.stopPropagation();
                showDeleteModal(id);
            };

            div.innerHTML = details;
            div.appendChild(deleteButton);
            return div;
        } catch (e) {
            return document.createElement('div');
        }
    }

    function updateTripLogUI(trips) {
        currentTrips = trips;
        const logArea = document.getElementById('log-area');
        logArea.innerHTML = ''; 
        
        if (trips.length === 0) {
            const p = document.createElement('p');
            p.className = "text-center text-gray-500 italic";
            p.id = "log-placeholder";
            p.textContent = "Log is empty. Start by adding a trip!";
            logArea.appendChild(p);

            document.getElementById('totalBusinessMileage').textContent = toFixed2(0.0);
            document.getElementById('totalDeduction').textContent = `$${toFixed2(0.0)}`;
            return;
        }

        let totalMileage = 0;
        trips.sort((a, b) => b.date - a.date);

        trips.forEach(trip => {
            const distance = parseFloat(trip.distance || 0);
            totalMileage += distance;
            const tripCard = renderTripCard(trip, trip.id);
            if (tripCard instanceof Node) { 
                logArea.appendChild(tripCard);
            }
        });

        document.getElementById('totalBusinessMileage').textContent = toFixed2(totalMileage);
        const totalDeduction = totalMileage * CRA_STANDARD_RATE_FIRST_TIER;
        document.getElementById('totalDeduction').textContent = `$${toFixed2(totalDeduction)}`;
    }
    
    function updateOdometerUI(odometerData) {
        const startOdoEl = document.getElementById('startOdo');
        const endOdoEl = document.getElementById('endOdo');
        const statusEl = document.getElementById('odometer-status');

        if (odometerData) {
            startOdoEl.value = odometerData.startOdo || '';
            endOdoEl.value = odometerData.endOdo || '';
            statusEl.textContent = `Readings for ${activeVehicleId} loaded.`;
            statusEl.className = 'text-sm mt-3 text-center text-green-600';
        } else {
            startOdoEl.value = '';
            endOdoEl.value = '';
            statusEl.textContent = `No annual readings found for ${activeVehicleId}. Please enter them.`;
            statusEl.className = 'text-sm mt-3 text-center text-blue-600';
        }
    }
    
    // --- Data Loading & Listeners ---

    function unsubscribeListeners() {
        if (unsubscribeTrips) {
            unsubscribeTrips();
            unsubscribeTrips = null;
        }
        if (unsubscribeOdo) {
            unsubscribeOdo();
            unsubscribeOdo = null;
        }
    }

    async function fetchOdometerForActiveVehicle() {
        if (!userId || !db) return;
        
        // Setup listener for Odometer
        const docRef = getOdometerDocRef(activeVehicleId);
        if (unsubscribeOdo) unsubscribeOdo(); // Clear old listener
        
        unsubscribeOdo = onSnapshot(docRef, (docSnap) => {
             if (docSnap.exists()) {
                updateOdometerUI(docSnap.data());
            } else {
                updateOdometerUI(null);
            }
        }, (error) => console.error("Error fetching odo", error));
    }
    
    function updateVehicleNameUI() {
        const vehicleName = document.getElementById('vehicleSelect').options[document.getElementById('vehicleSelect').selectedIndex].text;
        
        // Safe update with null check
        const currentVehicleNameEl = document.getElementById('currentVehicleName');
        if (currentVehicleNameEl) {
            currentVehicleNameEl.textContent = vehicleName;
        }
        
        const summaryVehicleNameEl = document.getElementById('summaryVehicleName');
        if (summaryVehicleNameEl) {
            summaryVehicleNameEl.textContent = vehicleName;
        }
    }

    function setupDataListeners() {
        if (!userId || !db) return;

        // 1. Odometer
        fetchOdometerForActiveVehicle();
        
        // 2. Trips (Filtered)
        const tripsCollectionRef = getTripCollectionRef();
        const q = query(
            tripsCollectionRef, 
            where('vehicleId', '==', activeVehicleId)
        );

        if (unsubscribeTrips) unsubscribeTrips(); // Clear old listener

        unsubscribeTrips = onSnapshot(q, (snapshot) => {
            const trips = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            updateTripLogUI(trips);
        }, (error) => {
            console.error("Error fetching filtered trips:", error); 
        });
    }
    
    function handleVehicleChange() {
        const newVehicleId = document.getElementById('vehicleSelect').value;
        activeVehicleId = newVehicleId;
        updateVehicleNameUI();
        setupDataListeners();
    }

    // --- Modal Logic ---
    const deleteModal = document.getElementById('deleteModal');
    const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
    const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
    let tripToDeleteId = null;

    function showDeleteModal(id) {
        tripToDeleteId = id;
        deleteModal.classList.remove('hidden');
    }

    function hideDeleteModal() {
        tripToDeleteId = null;
        deleteModal.classList.add('hidden');
    }

    confirmDeleteBtn.onclick = () => {
        if (tripToDeleteId) deleteTrip(tripToDeleteId);
        hideDeleteModal();
    };
    cancelDeleteBtn.onclick = hideDeleteModal;
    deleteModal.onclick = (e) => { if (e.target === deleteModal) hideDeleteModal(); };

    // --- CSV Export Logic ---

    function exportToCSV() {
        if (currentTrips.length === 0) {
            const statusEl = document.getElementById('trip-status');
            statusEl.textContent = 'No trips to export for this vehicle.';
            statusEl.className = 'text-sm mt-3 text-center text-red-600 font-medium h-5';
            setTimeout(() => statusEl.textContent = '', 3000);
            return;
        }

        const vehicleName = document.getElementById('vehicleSelect').options[document.getElementById('vehicleSelect').selectedIndex].text;
        let csv = `Vehicle,Date,Distance (Kilometers),Start Location,End Location,Business Purpose,Total Annual Business Kilometers (YTD)\n`;
        let totalMileage = 0;
        currentTrips.forEach(trip => { totalMileage += parseFloat(trip.distance); });
        
        currentTrips.forEach(trip => {
            const date = formatTimestampToDate(trip.date);
            const row = [
                vehicleName,
                date,
                trip.distance,
                `"${trip.start.replace(/"/g, '""')}"`,
                `"${trip.end.replace(/"/g, '""')}"`,
                `"${trip.purpose.replace(/"/g, '""')}"`,
                toFixed2(totalMileage)
            ].join(',');
            csv += row + "\n";
        });

        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', `CRA_Mileage_Log_Export_${activeVehicleId}_${new Date().toISOString().split('T')[0]}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // --- Initialization ---
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('tripDate').value = formatTimestampToDate(Date.now());
        
        // Safety check before running UI updates that depend on DOM
        if (document.getElementById('vehicleSelect')) {
            updateVehicleNameUI();
            document.getElementById('vehicleSelect').addEventListener('change', handleVehicleChange);
        }

        const tripForm = document.getElementById('trip-form');
        if (tripForm) tripForm.addEventListener('submit', addTrip);
        
        // NEW LISTENER FOR ROUND TRIP BUTTON
        const roundTripBtn = document.getElementById('roundTripBtn');
        if (roundTripBtn) roundTripBtn.addEventListener('click', addRoundTrip);
        
        const saveOdoBtn = document.getElementById('saveOdoBtn');
        if (saveOdoBtn) saveOdoBtn.addEventListener('click', saveOdometerReadings);
        
        const exportBtn = document.getElementById('exportBtn');
        if (exportBtn) exportBtn.addEventListener('click', exportToCSV);
        
        // Auth Buttons
        const googleBtn = document.getElementById('googleSignInBtn');
        if (googleBtn) googleBtn.addEventListener('click', window.loginWithGoogle);
        
        const signOutBtn = document.getElementById('signOutBtn');
        if (signOutBtn) signOutBtn.addEventListener('click', window.logout);

        initializeFirebase();
    });

</script>
</body>
</html>
